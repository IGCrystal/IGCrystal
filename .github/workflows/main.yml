name: Update README Countdown
on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´08:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      target_date:
        description: 'ç›®æ ‡æ—¥æœŸ (YYYY-MM-DD)'
        required: false
        default: '2025-10-16'
        type: string
      custom_message:
        description: 'è‡ªå®šä¹‰æ¶ˆæ¯'
        required: false
        default: 'æ­£åœ¨å®Œæˆè´¦å·åˆå¹¶ã€‚'
        type: string

env:
  DEFAULT_TARGET_DATE: "2025-10-16"
  DEFAULT_MESSAGE: "æ­£åœ¨å®Œæˆè´¦å·åˆå¹¶ã€‚"

jobs:
  update-countdown:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup timezone
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        echo "å½“å‰æ—¶é—´: $(date)"
        
    - name: Calculate countdown
      id: countdown
      run: |
        # è·å–ç›®æ ‡æ—¥æœŸå’Œæ¶ˆæ¯
        TARGET_DATE="${{ github.event.inputs.target_date || env.DEFAULT_TARGET_DATE }}"
        CUSTOM_MESSAGE="${{ github.event.inputs.custom_message || env.DEFAULT_MESSAGE }}"
        
        echo "ç›®æ ‡æ—¥æœŸ: $TARGET_DATE"
        echo "è‡ªå®šä¹‰æ¶ˆæ¯: $CUSTOM_MESSAGE"
        
        # éªŒè¯æ—¥æœŸæ ¼å¼
        if ! date -d "$TARGET_DATE" >/dev/null 2>&1; then
          echo "é”™è¯¯: æ— æ•ˆçš„æ—¥æœŸæ ¼å¼ $TARGET_DATE"
          exit 1
        fi
        
        # è®¡ç®—å‰©ä½™å¤©æ•°
        CURRENT_DATE=$(date +%Y-%m-%d)
        TARGET_TIMESTAMP=$(date -d "$TARGET_DATE" +%s)
        CURRENT_TIMESTAMP=$(date -d "$CURRENT_DATE" +%s)
        DAYS_LEFT=$(( (TARGET_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
        
        # å¦‚æœå€’è®¡æ—¶ç»“æŸï¼Œè®¾ç½®ä¸º0
        if [ $DAYS_LEFT -lt 0 ]; then
          DAYS_LEFT=0
        fi
        
        # è®¡ç®—é¡¹ç›®æ€»å¤©æ•°ï¼ˆå‡è®¾90å¤©çš„é¡¹ç›®å‘¨æœŸï¼‰
        TOTAL_PROJECT_DAYS=90
        ELAPSED_DAYS=$(( TOTAL_PROJECT_DAYS - DAYS_LEFT ))
        
        # è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
        if [ $TOTAL_PROJECT_DAYS -gt 0 ] && [ $ELAPSED_DAYS -ge 0 ]; then
          PROGRESS=$(( ELAPSED_DAYS * 100 / TOTAL_PROJECT_DAYS ))
          # ç¡®ä¿è¿›åº¦ä¸è¶…è¿‡100%
          if [ $PROGRESS -gt 100 ]; then
            PROGRESS=100
          fi
        else
          PROGRESS=0
        fi
        
        # ç”Ÿæˆè¿›åº¦æ¡
        PROGRESS_BAR=""
        FILLED_BLOCKS=$(( PROGRESS / 5 ))  # æ¯5%ä¸€ä¸ªæ–¹å—
        EMPTY_BLOCKS=$(( 20 - FILLED_BLOCKS ))
        
        for i in $(seq 1 $FILLED_BLOCKS); do
          PROGRESS_BAR="${PROGRESS_BAR}â–ˆ"
        done
        for i in $(seq 1 $EMPTY_BLOCKS); do
          PROGRESS_BAR="${PROGRESS_BAR}â–‘"
        done
        
        # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
        echo "target_date=$TARGET_DATE" >> $GITHUB_OUTPUT
        echo "custom_message=$CUSTOM_MESSAGE" >> $GITHUB_OUTPUT
        echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
        echo "progress_bar=$PROGRESS_BAR" >> $GITHUB_OUTPUT
        echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
        
        echo "å‰©ä½™å¤©æ•°: $DAYS_LEFT"
        echo "è¿›åº¦: $PROGRESS%"
        
    - name: Generate README content
      id: readme
      run: |
        DAYS_LEFT="${{ steps.countdown.outputs.days_left }}"
        TARGET_DATE="${{ steps.countdown.outputs.target_date }}"
        CUSTOM_MESSAGE="${{ steps.countdown.outputs.custom_message }}"
        PROGRESS="${{ steps.countdown.outputs.progress }}"
        PROGRESS_BAR="${{ steps.countdown.outputs.progress_bar }}"
        CURRENT_DATE="${{ steps.countdown.outputs.current_date }}"
        
        # ç”ŸæˆçŠ¶æ€æ ‡è®°
        if [ $DAYS_LEFT -eq 0 ]; then
          STATUS="ğŸ‰ å·²å®Œæˆ"
          STATUS_TEXT="å·²å®Œæˆ"
          STATUS_COLOR="brightgreen"
        elif [ $DAYS_LEFT -le 7 ]; then
          STATUS="ğŸ”¥ å³å°†åˆ°æœŸ"
          STATUS_TEXT="å³å°†åˆ°æœŸ"
          STATUS_COLOR="red"
        elif [ $DAYS_LEFT -le 30 ]; then
          STATUS="âš¡ è¿›è¡Œä¸­"
          STATUS_TEXT="è¿›è¡Œä¸­"
          STATUS_COLOR="orange"
        else
          STATUS="ğŸ“… è®¡åˆ’ä¸­"
          STATUS_TEXT="è®¡åˆ’ä¸­"
          STATUS_COLOR="blue"
        fi
        
        # URLç¼–ç çŠ¶æ€æ–‡æœ¬ï¼ˆå¤„ç†ä¸­æ–‡å­—ç¬¦ï¼‰
        STATUS_ENCODED=$(echo "$STATUS_TEXT" | sed 's/ /%20/g')
        
        # ç”ŸæˆREADMEå†…å®¹
        cat > README.md << EOF
        # åˆ«æ¥æ— æ™! ğŸ‘‹

        ## ğŸ“Š è´¦å·çŠ¶æ€
        
        **$CUSTOM_MESSAGE**
        
        ### â° å€’è®¡æ—¶ä¿¡æ¯
        
        - ğŸ¯ **ç›®æ ‡æ—¥æœŸ**: $TARGET_DATE
        - ğŸ“… **å½“å‰æ—¥æœŸ**: $CURRENT_DATE  
        - â³ **å‰©ä½™å¤©æ•°**: **$DAYS_LEFT** å¤©
        - ğŸ“ˆ **å®Œæˆè¿›åº¦**: $PROGRESS%
        - ğŸ·ï¸ **çŠ¶æ€**: $STATUS
        
        ### ğŸ“Š è¿›åº¦å¯è§†åŒ–
        
        \`\`\`
        [$PROGRESS_BAR] $PROGRESS%
        \`\`\`
        
        ![Status](https://img.shields.io/badge/çŠ¶æ€-$STATUS_ENCODED-$STATUS_COLOR)
        ![Progress](https://img.shields.io/badge/è¿›åº¦-$PROGRESS%25-blue)
        ![Days Left](https://img.shields.io/badge/å‰©ä½™å¤©æ•°-$DAYS_LEFT-orange)
        
        **æœ€åæ›´æ–°**: $(date '+%Y-%m-%d %H:%M:%S %Z')
        
        EOF
        
        echo "README å†…å®¹å·²ç”Ÿæˆ"
        
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet README.md; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ° README å˜åŒ–"
          git diff README.md
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        # é…ç½® Git
        git config --local user.email "cacheigcrystal@gmail.com"
        git config --local user.name "IGCrystal-Ghost"
        
        # æ·»åŠ æ–‡ä»¶
        git add README.md
        
        # åˆ›å»ºæäº¤æ¶ˆæ¯
        DAYS_LEFT="${{ steps.countdown.outputs.days_left }}"
        COMMIT_MESSAGE="ğŸ¤– Auto-update: è¿˜å‰© $DAYS_LEFT å¤© ($(date '+%Y-%m-%d %H:%M'))"
        
        # æäº¤å’Œæ¨é€
        git commit -m "$COMMIT_MESSAGE"
        git push
        
        echo "âœ… æˆåŠŸæäº¤å¹¶æ¨é€æ›´æ”¹"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
